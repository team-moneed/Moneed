name: Deploy Applications

on:
    push:
        branches: [main, release, hotfix]
    pull_request:
        branches: [main, release]

permissions:
    security-events: write
    contents: read
    packages: write

env:
    NODE_VERSION: '20'
    REGISTRY: ghcr.io
    IMAGE_NAME: moneed/kakao-proxy
    GITHUB_ACTOR: team-moneed

jobs:
    # ë³€ê²½ì‚¬í•­ ê°ì§€
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            web-changed: ${{ steps.changes.outputs.web }}
            kakao-changed: ${{ steps.changes.outputs.kakao }}
            packages-changed: ${{ steps.changes.outputs.packages }}
            any-changed: ${{ steps.changes.outputs.web == 'true' || steps.changes.outputs.kakao == 'true' || steps.changes.outputs.packages == 'true' }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Detect changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      web:
                        - 'apps/web/**'
                        - 'vercel.json'
                      kakao:
                        - 'apps/kakao-proxy-server/**'
                        - 'Dockerfile'
                        - '.dockerignore'
                      packages:
                        - 'packages/**'
                        - 'package.json'
                        - 'yarn.lock'
                        - '.github/workflows/deploy.yml'

    # ë¹Œë“œ í…ŒìŠ¤íŠ¸
    build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Build applications
              run: yarn build:apps

            - name: Run linting
              run: yarn lint

            - name: Run type checking
              run: yarn type-check

    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Run tests with coverage
              run: |
                  if [ -f "packages/shared/auth/package.json" ] && grep -q '"test:coverage"' packages/shared/auth/package.json; then
                    yarn workspace @moneed/auth test:coverage
                  else
                    echo "No coverage tests found"
                  fi

            - name: Upload coverage reports
              if: success()
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./packages/shared/auth/coverage/lcov.info
                  fail_ci_if_error: false

    # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
    docker-build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (test only)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: false
                  tags: kakao-proxy:test
                  load: true
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Verify Docker image exists
              run: |
                  echo "Checking if Docker image was built successfully..."
                  docker images kakao-proxy:test
                  if ! docker images kakao-proxy:test | grep -q kakao-proxy; then
                      echo "Error: Docker image was not built successfully"
                      exit 1
                  fi

            - name: Test Docker image
              run: |
                  # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
                  docker run --rm -d --name test-container -p 8001:8000 kakao-proxy:test
                  sleep 10

                  # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
                  curl -f http://localhost:8001/health || exit 1

                  # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                  docker stop test-container

    # PR ë¯¸ë¦¬ë³´ê¸° ë°°í¬ (Vercel)
    deploy-preview:
        runs-on: ubuntu-latest
        needs: [build-test, test]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy Preview to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  github-comment: true

    # ì½”ë“œ í’ˆì§ˆ ì²´í¬
    code-quality:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run ESLint with annotations
              run: |
                  # ê¸°ë³¸ lint ì‹¤í–‰
                  yarn lint

    # ë³´ì•ˆ ìŠ¤ìº”
    security-scan:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy scan results
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: 'trivy-results.sarif'

    # Vercel ë°°í¬ (ì›¹ ì•±)
    deploy-web:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: '--prod'
                  working-directory: ./

    # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    build-and-push-docker:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test, docker-build-test, code-quality, security-scan]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.kakao-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        permissions:
            contents: read
            packages: write
        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}
            image-digest: ${{ steps.build.outputs.digest }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: ë””ë²„ê¹…ì„ ìœ„í•œ ë³€ìˆ˜ ê°’ í™•ì¸
              run: |
                  echo "REGISTRY: ${{ env.REGISTRY }}"
                  echo "ACTOR: ${{ env.GITHUB_ACTOR }}"
                  echo "IMAGE_NAME: ${{ env.IMAGE_NAME }}"

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ env.GITHUB_ACTOR }}
                  password: ${{ secrets.PAT }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.GITHUB_ACTOR }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64

        # AWS EC2 ë°°í¬
    deploy-to-ec2:
        runs-on: ubuntu-latest
        needs: [build-and-push-docker]
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup environment variables
              run: |
                  echo "IMAGE_TAG=${{ needs.build-and-push-docker.outputs.image-tag }}" >> $GITHUB_ENV
                  echo "GITHUB_ACTOR=${{ env.GITHUB_ACTOR }}" >> $GITHUB_ENV

            - name: Check environment variables
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ” í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

                      if [ -z "${{ env.IMAGE_TAG }}" ]; then
                          echo "âš ï¸ IMAGE_TAGê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ 'latest'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                          export IMAGE_TAG="latest"
                      else
                          export IMAGE_TAG="${{ env.IMAGE_TAG }}"
                      fi

                      echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ: $IMAGE_TAG"

                      # Docker Compose íŒŒì¼ ì¡´ì¬ í™•ì¸
                      if [ ! -f "docker-compose.yml" ]; then
                          echo "âŒ Docker Compose íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: docker-compose.yml"
                          exit 1
                      fi

            - name: Check SSL certificates
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ”’ SSL ì¸ì¦ì„œë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

                      SSL_DIR="./nginx/ssl"

                      if [ ! -f "$SSL_DIR/server.crt" ] || [ ! -f "$SSL_DIR/server.key" ]; then
                          echo "âš ï¸ SSL ì¸ì¦ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìì²´ ì„œëª… ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
                          
                          if [ -f "scripts/generate-ssl-cert.sh" ]; then
                              chmod +x scripts/generate-ssl-cert.sh
                              ./scripts/generate-ssl-cert.sh
                          else
                              echo "âš ï¸ SSL ì¸ì¦ì„œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                          fi
                      else
                          echo "âœ… SSL ì¸ì¦ì„œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
                      fi

            - name: Docker login and pull image
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ” Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤..."
                      echo "${{ secrets.PAT }}" | docker login ${{ env.REGISTRY }} -u ${{ env.GITHUB_ACTOR }} --password-stdin
                      echo "âœ… Docker ë¡œê·¸ì¸ ì™„ë£Œ"

                      echo "ğŸ“¦ ìƒˆ Docker ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤..."
                      IMAGE_TAG="${{ env.IMAGE_TAG }}"
                      if [ -z "$IMAGE_TAG" ]; then
                          IMAGE_TAG="latest"
                      fi

                      # í˜„ì¬ ì´ë¯¸ì§€ë¥¼ ë°±ì—… íƒœê·¸ë¡œ ì €ì¥
                      IMAGE_NAME="${{ env.REGISTRY }}/${{ env.GITHUB_ACTOR }}/moneed/kakao-proxy"
                      if docker images -q "$IMAGE_NAME:latest" | grep -q .; then
                          docker tag "$IMAGE_NAME:latest" "$IMAGE_NAME:latest-backup"
                      fi

                      docker pull "$IMAGE_TAG"
                      echo "âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: $IMAGE_TAG"

            - name: Backup current services
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ’¾ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤..."

                      BACKUP_DIR="/home/${{ secrets.EC2_USER }}/backups"
                      mkdir -p $BACKUP_DIR

                      if docker-compose ps 2>/dev/null | grep -q "Up"; then
                          docker-compose ps > "$BACKUP_DIR/compose-status-$(date +%Y%m%d-%H%M%S).txt"
                          docker-compose logs > "$BACKUP_DIR/compose-logs-$(date +%Y%m%d-%H%M%S).log" 2>&1
                          echo "âœ… ì„œë¹„ìŠ¤ ë°±ì—… ì™„ë£Œ"
                      else
                          echo "âš ï¸ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
                      fi

            - name: Stop current services
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "â¹ï¸ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."

                      if docker-compose ps 2>/dev/null | grep -q "Up"; then
                          docker-compose down
                          echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"
                      else
                          echo "âš ï¸ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
                      fi

            - name: Start new services
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸš€ ìƒˆ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

                      ENV_FILE="/home/${{ secrets.EC2_USER }}/.env.production"

                      # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸
                      if [ ! -f "$ENV_FILE" ]; then
                          echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $ENV_FILE"
                          echo "âš ï¸ env-templates/production.env.templateì„ ì°¸ê³ í•˜ì—¬ íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”."
                          exit 1
                      fi

                      # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                      export GITHUB_ACTOR="${{ env.GITHUB_ACTOR }}"
                      export IMAGE_TAG="${{ env.IMAGE_TAG }}"
                      if [ -z "$IMAGE_TAG" ]; then
                          export IMAGE_TAG="latest"
                      fi

                      # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
                      docker-compose rm -f -s -v || true
                      docker-compose up -d --force-recreate --remove-orphans

                      echo "âœ… ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ (Nginx + Kakao Proxy with HTTPS)"

            - name: Health check
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."

                      CONTAINER_NAME="kakao-proxy"
                      NGINX_CONTAINER_NAME="nginx-proxy"

                      # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
                      sleep 15

                      # HTTP í—¬ìŠ¤ì²´í¬ (ë‚´ë¶€ í†µì‹ )
                      echo "ğŸ” HTTP í—¬ìŠ¤ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
                      for i in {1..6}; do
                          if docker exec "$CONTAINER_NAME" curl -sf http://localhost:8000/health &>/dev/null; then
                              echo "âœ… HTTP í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                              break
                          fi
                          echo "âš ï¸ HTTP í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/6 ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
                          sleep 5
                          if [ $i -eq 6 ]; then
                              echo "âŒ HTTP í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                              docker-compose logs app
                              exit 1
                          fi
                      done

                      # HTTPS í—¬ìŠ¤ì²´í¬
                      echo "ğŸ”’ HTTPS í—¬ìŠ¤ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
                      for i in {1..6}; do
                          if docker exec "$NGINX_CONTAINER_NAME" curl -skf https://localhost/health &>/dev/null; then
                              echo "âœ… HTTPS í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                              break
                          fi
                          echo "âš ï¸ HTTPS í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/6 ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
                          sleep 5
                          if [ $i -eq 6 ]; then
                              echo "âŒ HTTPS í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                              docker-compose logs
                              exit 1
                          fi
                      done

            - name: Cleanup old images
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ§¹ ì´ì „ Docker ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."

                      # 72ì‹œê°„ ì´ì „ ì´ë¯¸ì§€ ì œê±°
                      docker image prune -af --filter "until=72h"

                      # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì œê±°
                      docker image prune -f

                      echo "âœ… ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

            - name: Check deployment status
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      echo "ğŸ“Š ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

                      CONTAINER_NAME="kakao-proxy"
                      NGINX_CONTAINER_NAME="nginx-proxy"

                      echo ""
                      echo "âœ… Docker Compose ì„œë¹„ìŠ¤ ìƒíƒœ:"
                      docker-compose ps
                      echo ""

                      # ê°œë³„ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                      if docker ps -f name=$CONTAINER_NAME | grep -q "Up"; then
                          echo "âœ… Kakao Proxy ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                      else
                          echo "âŒ Kakao Proxy ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                          exit 1
                      fi

                      if docker ps -f name=$NGINX_CONTAINER_NAME | grep -q "Up"; then
                          echo "âœ… Nginx í”„ë¡ì‹œ ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                      else
                          echo "âŒ Nginx í”„ë¡ì‹œ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                          exit 1
                      fi

                      # í¬íŠ¸ ì‚¬ìš© í™•ì¸
                      echo ""
                      echo "ğŸ“¡ í¬íŠ¸ ì‚¬ìš© í˜„í™©:"
                      echo "HTTP (80): $(netstat -tlnp | grep ':80 ' || echo 'ì‚¬ìš© ì•ˆí•¨')"
                      echo "HTTPS (443): $(netstat -tlnp | grep ':443 ' || echo 'ì‚¬ìš© ì•ˆí•¨')"
                      echo "App (8000): $(netstat -tlnp | grep ':8000 ' || echo 'ì‚¬ìš© ì•ˆí•¨')"
                      echo ""

                      # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
                      DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
                      if [ "$DISK_USAGE" -gt 80 ]; then
                          echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤: ${DISK_USAGE}%"
                      else
                          echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${DISK_USAGE}%"
                      fi

                      # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
                      MEMORY_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
                      if [ "$MEMORY_USAGE" -gt 80 ]; then
                          echo "âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤: ${MEMORY_USAGE}%"
                      else
                          echo "ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${MEMORY_USAGE}%"
                      fi

                      # ìµœì¢… ì„±ê³µ ë©”ì‹œì§€
                      echo ""
                      echo "ğŸ‰ HTTPS ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                      echo ""
                      echo "âœ… ì ‘ì† URL:"
                      echo "  - HTTPS: https://${{ secrets.EC2_HOST }}"
                      echo "  - HTTP: http://${{ secrets.EC2_HOST }} (ìë™ìœ¼ë¡œ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜)"
                      echo "  - í—¬ìŠ¤ì²´í¬: https://${{ secrets.EC2_HOST }}/health"
                      echo ""
                      echo "âš ï¸ ìì²´ ì„œëª… ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ë³´ì•ˆ ê²½ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤."

    # ë°°í¬ ì•Œë¦¼
    notify-deployment:
        runs-on: ubuntu-latest
        needs: [deploy-web, deploy-to-ec2]
        if: always() && github.ref == 'refs/heads/main'
        steps:
            - name: Notify deployment status
              run: |
                  WEB_STATUS="${{ needs.deploy-web.result }}"
                  EC2_STATUS="${{ needs.deploy-to-ec2.result }}"

                  echo "ğŸš€ Deployment Summary:"
                  echo "Web App (Vercel): ${WEB_STATUS:-skipped}"
                  echo "Kakao Proxy (EC2): ${EC2_STATUS:-skipped}"

                  if [[ "$WEB_STATUS" == "failure" || "$EC2_STATUS" == "failure" ]]; then
                    echo "âŒ Some deployments failed"
                    exit 1
                  else
                    echo "âœ… All deployments successful"
                  fi
