name: Deploy Applications

on:
    push:
        branches: [main, release, hotfix]
    pull_request:
        branches: [main, release]

permissions:
    security-events: write

env:
    NODE_VERSION: '20'
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/kakao-proxy

jobs:
    # ë³€ê²½ì‚¬í•­ ê°ì§€
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            web-changed: ${{ steps.changes.outputs.web }}
            kakao-changed: ${{ steps.changes.outputs.kakao }}
            packages-changed: ${{ steps.changes.outputs.packages }}
            any-changed: ${{ steps.changes.outputs.web == 'true' || steps.changes.outputs.kakao == 'true' || steps.changes.outputs.packages == 'true' }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Detect changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      web:
                        - 'apps/web/**'
                        - 'vercel.json'
                      kakao:
                        - 'apps/kakao-proxy-server/**'
                        - 'Dockerfile'
                        - '.dockerignore'
                      packages:
                        - 'packages/**'
                        - 'package.json'
                        - 'yarn.lock'

    # ë¹Œë“œ í…ŒìŠ¤íŠ¸
    build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Build applications
              run: yarn build:apps

            - name: Run linting
              run: yarn lint

            - name: Run type checking
              run: yarn type-check

    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Run tests with coverage
              run: |
                  if [ -f "packages/shared/auth/package.json" ] && grep -q '"test:coverage"' packages/shared/auth/package.json; then
                    yarn workspace @moneed/auth test:coverage
                  else
                    echo "No coverage tests found"
                  fi

            - name: Upload coverage reports
              if: success()
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./packages/shared/auth/coverage/lcov.info
                  fail_ci_if_error: false

    # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
    docker-build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (test only)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: false
                  tags: kakao-proxy:test
                  load: true
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Verify Docker image exists
              run: |
                  echo "Checking if Docker image was built successfully..."
                  docker images kakao-proxy:test
                  if ! docker images kakao-proxy:test | grep -q kakao-proxy; then
                      echo "Error: Docker image was not built successfully"
                      exit 1
                  fi

            - name: Test Docker image
              run: |
                  # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
                  docker run --rm -d --name test-container -p 8001:8000 kakao-proxy:test
                  sleep 10

                  # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
                  curl -f http://localhost:8001/health || exit 1

                  # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                  docker stop test-container

    # PR ë¯¸ë¦¬ë³´ê¸° ë°°í¬ (Vercel)
    deploy-preview:
        runs-on: ubuntu-latest
        needs: [build-test, test]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy Preview to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  github-comment: true

    # ì½”ë“œ í’ˆì§ˆ ì²´í¬
    code-quality:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run ESLint with annotations
              run: |
                  # ê¸°ë³¸ lint ì‹¤í–‰
                  yarn lint

    # ë³´ì•ˆ ìŠ¤ìº”
    security-scan:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy scan results
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: 'trivy-results.sarif'

    # Vercel ë°°í¬ (ì›¹ ì•±)
    deploy-web:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: '--prod'
                  working-directory: ./

    # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    build-and-push-docker:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test, docker-build-test, code-quality, security-scan]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.kakao-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        permissions:
            contents: read
            packages: write
        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}
            image-digest: ${{ steps.build.outputs.digest }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: ë””ë²„ê¹…ì„ ìœ„í•œ ë³€ìˆ˜ ê°’ í™•ì¸
              run: |
                  echo "REGISTRY: ${{ env.REGISTRY }}"
                  echo "ACTOR: ${{ github.actor }}"
                  echo "IMAGE_NAME: ${{ env.IMAGE_NAME }}"

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64

    # AWS EC2 ë°°í¬
    deploy-to-ec2:
        runs-on: ubuntu-latest
        needs: [build-and-push-docker]
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                      export IMAGE_TAG="${{ needs.build-and-push-docker.outputs.image-tag }}"

                      # Docker ë¡œê·¸ì¸
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

                      # ìƒˆ ì´ë¯¸ì§€ í’€
                      docker pull $IMAGE_TAG

                      # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ì¡´ì¬í•  ê²½ìš°)
                      docker stop kakao-proxy || true
                      docker rm kakao-proxy || true

                      # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë…ë¦½ì ì¸ Prisma ì„¤ì • ì‚¬ìš©)
                      docker run -d \
                        --name kakao-proxy \
                        --restart unless-stopped \
                        -p 8000:8000 \
                        --env-file /home/${{ secrets.EC2_USER }}/.env.production \
                        $IMAGE_TAG

                      # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœì‹  2ê°œ ë²„ì „ë§Œ ìœ ì§€)
                      docker image prune -af --filter "until=72h"

                      # í—¬ìŠ¤ì²´í¬
                      sleep 10
                      curl -f http://localhost:8000/health || exit 1

    # ë°°í¬ ì•Œë¦¼
    notify-deployment:
        runs-on: ubuntu-latest
        needs: [deploy-web, deploy-to-ec2]
        if: always() && github.ref == 'refs/heads/main'
        steps:
            - name: Notify deployment status
              run: |
                  WEB_STATUS="${{ needs.deploy-web.result }}"
                  EC2_STATUS="${{ needs.deploy-to-ec2.result }}"

                  echo "ğŸš€ Deployment Summary:"
                  echo "Web App (Vercel): ${WEB_STATUS:-skipped}"
                  echo "Kakao Proxy (EC2): ${EC2_STATUS:-skipped}"

                  if [[ "$WEB_STATUS" == "failure" || "$EC2_STATUS" == "failure" ]]; then
                    echo "âŒ Some deployments failed"
                    exit 1
                  else
                    echo "âœ… All deployments successful"
                  fi
