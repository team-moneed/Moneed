name: Continuous Integration

on:
    push:
        branches: [main, release, develop]
    pull_request:
        branches: [main, release, develop]

permissions:
    security-events: write

env:
    NODE_VERSION: '20'

jobs:
    # 변경사항 감지
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            any-changed: ${{ steps.changes.outputs.web == 'true' || steps.changes.outputs.kakao == 'true' || steps.changes.outputs.packages == 'true' }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Detect changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      web:
                        - 'apps/web/**'
                        - 'vercel.json'
                      kakao:
                        - 'apps/kakao-proxy-server/**'
                      packages:
                        - 'packages/**'
                        - 'package.json'
                        - 'yarn.lock'

    # 빌드 테스트
    build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Build applications
              run: yarn build:apps

            - name: Run linting
              run: yarn lint

            - name: Run type checking
              run: yarn type-check

    # PR 미리보기 배포 (Vercel)
    deploy-preview:
        runs-on: ubuntu-latest
        needs: [build-test, test]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy Preview to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  github-comment: true
