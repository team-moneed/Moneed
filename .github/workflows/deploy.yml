name: Deploy Applications

on:
    push:
        branches: [main, release, hotfix]
    pull_request:
        branches: [main, release]

permissions:
    security-events: write

env:
    NODE_VERSION: '20'
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/kakao-proxy

jobs:
    # 변경사항 감지
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            web-changed: ${{ steps.changes.outputs.web }}
            kakao-changed: ${{ steps.changes.outputs.kakao }}
            packages-changed: ${{ steps.changes.outputs.packages }}
            any-changed: ${{ steps.changes.outputs.web == 'true' || steps.changes.outputs.kakao == 'true' || steps.changes.outputs.packages == 'true' }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Detect changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      web:
                        - 'apps/web/**'
                        - 'vercel.json'
                      kakao:
                        - 'apps/kakao-proxy-server/**'
                        - 'Dockerfile'
                        - '.dockerignore'
                      packages:
                        - 'packages/**'
                        - 'package.json'
                        - 'yarn.lock'

    # 빌드 테스트
    build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Build applications
              run: yarn build:apps

            - name: Run linting
              run: yarn lint

            - name: Run type checking
              run: yarn type-check

    # 테스트 실행
    test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build packages
              run: yarn build:packages

            - name: Generate Prisma clients
              run: |
                  cd apps/web && yarn db:generate
                  cd ../kakao-proxy-server && yarn db:generate
                  cd ../..

            - name: Run tests with coverage
              run: |
                  if [ -f "packages/shared/auth/package.json" ] && grep -q '"test:coverage"' packages/shared/auth/package.json; then
                    yarn workspace @moneed/auth test:coverage
                  else
                    echo "No coverage tests found"
                  fi

            - name: Upload coverage reports
              if: success()
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./packages/shared/auth/coverage/lcov.info
                  fail_ci_if_error: false

    # Docker 빌드 테스트
    docker-build-test:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (test only)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: false
                  tags: kakao-proxy:test
                  load: true
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Verify Docker image exists
              run: |
                  echo "Checking if Docker image was built successfully..."
                  docker images kakao-proxy:test
                  if ! docker images kakao-proxy:test | grep -q kakao-proxy; then
                      echo "Error: Docker image was not built successfully"
                      exit 1
                  fi

            - name: Test Docker image
              run: |
                  # 컨테이너 실행 테스트
                  docker run --rm -d --name test-container -p 8001:8000 kakao-proxy:test
                  sleep 10

                  # 헬스체크 테스트
                  curl -f http://localhost:8001/health || exit 1

                  # 컨테이너 중지
                  docker stop test-container

    # PR 미리보기 배포 (Vercel)
    deploy-preview:
        runs-on: ubuntu-latest
        needs: [build-test, test]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy Preview to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  github-comment: true

    # 코드 품질 체크
    code-quality:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run ESLint with annotations
              run: |
                  # 기본 lint 실행
                  yarn lint

    # 보안 스캔
    security-scan:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.any-changed == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy scan results
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: 'trivy-results.sarif'

    # Vercel 배포 (웹 앱)
    deploy-web:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: '--prod'
                  working-directory: ./

    # Docker 이미지 빌드 및 푸시
    build-and-push-docker:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-test, test, docker-build-test, code-quality, security-scan]
        if: |
            github.ref == 'refs/heads/main' && 
            (needs.detect-changes.outputs.kakao-changed == 'true' || needs.detect-changes.outputs.packages-changed == 'true')
        permissions:
            contents: read
            packages: write
        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}
            image-digest: ${{ steps.build.outputs.digest }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: 디버깅을 위한 변수 값 확인
              run: |
                  echo "REGISTRY: ${{ env.REGISTRY }}"
                  echo "ACTOR: ${{ github.actor }}"
                  echo "IMAGE_NAME: ${{ env.IMAGE_NAME }}"

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64

    # AWS EC2 배포
    deploy-to-ec2:
        runs-on: ubuntu-latest
        needs: [build-and-push-docker]
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_SSH_PORT || 22 }}
                  script: |
                      # 환경변수 설정
                      export IMAGE_TAG="${{ needs.build-and-push-docker.outputs.image-tag }}"

                      # Docker 로그인
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

                      # 새 이미지 풀
                      docker pull $IMAGE_TAG

                      # 기존 컨테이너 중지 및 제거 (존재할 경우)
                      docker stop kakao-proxy || true
                      docker rm kakao-proxy || true

                      # 새 컨테이너 실행 (독립적인 Prisma 설정 사용)
                      docker run -d \
                        --name kakao-proxy \
                        --restart unless-stopped \
                        -p 8000:8000 \
                        --env-file /home/${{ secrets.EC2_USER }}/.env.production \
                        $IMAGE_TAG

                      # 이전 이미지 정리 (최신 2개 버전만 유지)
                      docker image prune -af --filter "until=72h"

                      # 헬스체크
                      sleep 10
                      curl -f http://localhost:8000/health || exit 1

    # 배포 알림
    notify-deployment:
        runs-on: ubuntu-latest
        needs: [deploy-web, deploy-to-ec2]
        if: always() && github.ref == 'refs/heads/main'
        steps:
            - name: Notify deployment status
              run: |
                  WEB_STATUS="${{ needs.deploy-web.result }}"
                  EC2_STATUS="${{ needs.deploy-to-ec2.result }}"

                  echo "🚀 Deployment Summary:"
                  echo "Web App (Vercel): ${WEB_STATUS:-skipped}"
                  echo "Kakao Proxy (EC2): ${EC2_STATUS:-skipped}"

                  if [[ "$WEB_STATUS" == "failure" || "$EC2_STATUS" == "failure" ]]; then
                    echo "❌ Some deployments failed"
                    exit 1
                  else
                    echo "✅ All deployments successful"
                  fi
